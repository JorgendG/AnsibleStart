---
- name: Create VM
  hosts:
    - hyperdrive
  gather_facts: no
  tasks:
    - name: Importeer vm vars
      include_vars:
        file: "homelabvms.yml"

    - name: list vms
      debug: msg="[hyperdrive] vm list is  {{ item.name }}"
      with_items: "{{ vms }}"

    - name: Create mynewvm4 VM
      win_hyperv_guest:
        name: "{{ item.name }}"
        generation: 2
        memory: "{{ item.memory }}"
        diskpath: "{{ item.diskpath }}"
        network_switch: External
        cpu: "{{ item.cpu }}"
        state: present
      register: macadres
      with_items: "{{ vms }}"

    - name: debug macadres
      debug: msg="[macadres] is {{ item.changed }}"
      with_items: "{{ macadres.results }}"

- name: Create WDS Registration
  hosts:
    - wds01
  gather_facts: no
  tasks:
    - name: Importeer vm vars
      include_vars:
        file: "homelabvms.yml"

    - name: debug vms
      debug: msg="[vms] is {{ item.name }}"
      with_items: "{{ vms }}"

    - name: WDS Registration
      win_wds_reservation:
        name: "{{ item.vmname }}"
        macaddress: "{{ item.macaddress }}"
        unattend: "{{ item.item.unattend }}"
        state: present
      with_items: "{{ hostvars['hyperdrive']['macadres']['results'] }}"
      when: item.changed == true

- name: Start VM
  hosts:
    - hyperdrive
  gather_facts: no
  tasks:
    - name: Start VM
      win_hyperv_guest:
        name: "{{ item.vmname }}"
        state: started
      with_items: "{{ hostvars['hyperdrive']['macadres']['results'] }}"
